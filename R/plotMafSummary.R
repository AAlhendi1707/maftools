#' Plots maf summary.
#'
#' @description Plots maf summary.
#'
#' @param maf an MAF object generated by \code{\link{read.maf}}
#' @param file If given pdf file will be generated.
#' @param width plot parameter for output file.
#' @param height plot parameter for output file.
#' @param rmOutlier If TRUE removes outlier from boxplot.
#' @param addStat Can be either mean or median. Default NULL.
#' @export

plotmafSummary = function(maf, file = NULL, width = 6, height = 5, rmOutlier = T, addStat = NULL){

  require(cowplot, quietly = T)


  addStat.opts = c('mean', 'median')

  #hard coded color scheme
  col = c('#CCCCCC',brewer.pal(12, name = "Paired"), brewer.pal(11, name = "Spectral")[1:3], "maroon")
  names(col) = names = c('',"Nonstop_Mutation", "Frame_Shift_Del",
                         "Intron", "Missense_Mutation", "IGR", "Nonsense_Mutation",
                         "RNA", "Splice_Site", "In_Frame_Del", "Frame_Shift_Ins",
                         "Silent", "In_Frame_Ins", "ITD", "In_Frame_Ins", "Translation_Start_Site",
                         "two_hit")

  vcs = getSampleSummary(maf)
  #vcs = vcs[,2:(ncol(vcs)-1), with = F]
  #vcs = vcs[order(rowSums(vcs[,2:ncol(vcs), with = F]), decreasing = T)] #order tsbs based on number of mutations
  vcs = vcs[,c(1,order(colSums(x = vcs[,2:(ncol(vcs)-1), with =F]), decreasing = T)+1), with =F] #order based on most event

  #melt data frame
  vcs.m = melt(vcs, id.vars = 'Tumor_Sample_Barcode')
  colnames(vcs.m) = c('Tumor_Sample_Barcode', 'Variant_Classification', 'N')

  vcs.m$Tumor_Sample_Barcode = factor(vcs.m$Tumor_Sample_Barcode,levels = vcs$Tumor_Sample_Barcode) #reorder tsb levels
  vcs.m$Variant_Classification = factor(x = vcs.m$Variant_Classification, levels = colnames(vcs)) #reorder Variant classification



  #top ggplot

  if(!is.null(addStat)){
    if(length(addStat) > 1){
      stop('addStat can only be either mean or median.')
    }

    if(! addStat %in% addStat.opts){
      stop('addStat can only be either mean or median.')
    }

    if(addStat == 'mean'){
      mean.line = round(max(maf@summary[,Mean], na.rm = T), 2)
      df = data.frame(y = c(mean.line), x = as.integer(0.8*nrow(getSampleSummary(maf))), label = c(paste('Mean: ', mean.line, sep='')))

      vcs.gg = ggplot(data = vcs.m, aes(x = Tumor_Sample_Barcode, y = N, fill = Variant_Classification))+geom_bar(stat = 'identity')+scale_fill_manual(values = col)+
        theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = 'none')+ylab('# of Variants')+xlab('Samples')+
        background_grid(major = 'xy', minor = 'none')+geom_hline(yintercept = mean.line, linetype = 2)+
        geom_label_repel(inherit.aes = F, data = df, aes(x = x, y = y, label = label), fill = 'gray', fontface = 'bold', color = 'black', box.padding = unit(1, "lines"),
                         point.padding = unit(1, "lines"), force = 20, size = 3, nudge_y = 2)
    }else{
      med.line = round(max(maf@summary[,Median], na.rm = T), 2)
      df = data.frame(y = c(med.line), x = as.integer(0.8*nrow(getSampleSummary(maf))), label = c(paste('Median: ', med.line, sep='')))

      vcs.gg = ggplot(data = vcs.m, aes(x = Tumor_Sample_Barcode, y = N, fill = Variant_Classification))+geom_bar(stat = 'identity')+scale_fill_manual(values = col)+
        theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = 'none')+ylab('# of Variants')+xlab('Samples')+
        background_grid(major = 'xy', minor = 'none')+geom_hline(yintercept = med.line, linetype = 2)+
        geom_label_repel(inherit.aes = F, data = df, aes(x = x, y = y, label = label), fill = 'gray', fontface = 'bold', color = 'black', box.padding = unit(1, "lines"),
                         point.padding = unit(1, "lines"), force = 20, size = 3, nudge_y = 2)
    }


  }else{
    vcs.gg = ggplot(data = vcs.m, aes(x = Tumor_Sample_Barcode, y = N, fill = Variant_Classification))+geom_bar(stat = 'identity')+scale_fill_manual(values = col)+
      theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = 'none')+ylab('# of Variants')+xlab('Samples')+
      background_grid(major = 'xy', minor = 'none')
  }

  #bottom ggplot
  if(rmOutlier){
    #Get box heights from boxplot.srtas
    boxH = ddply(.data = vcs.m, .variables = c('Variant_Classification'), .fun = summarize, boxStat = boxplot.stats(N)$stat[5])
    vcs.gg2 = ggplot(data = vcs.m, aes(x = Variant_Classification, y = N, fill = Variant_Classification))+geom_boxplot(outlier.shape = NA)+scale_fill_manual(values = col)+
      theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = 'bottom')+
      theme(legend.key.size = unit(0.5, "cm"), legend.title = element_blank(), legend.text = element_text(size = 7))+ylim(0, max(boxH$boxStat)+5)+background_grid(major = 'xy', minor = 'none')
  } else{
    vcs.gg2 = ggplot(data = vcs.m, aes(x = Variant_Classification, y = N, fill = Variant_Classification))+geom_boxplot()+scale_fill_manual(values = col)+
      theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = 'bottom')+
      theme(legend.key.size = unit(0.5, "cm"), legend.title = element_blank(), legend.text = element_text(size = 7))+background_grid(major = 'xy', minor = 'none')
  }

  #organize plots
  gg.summary = plot_grid(vcs.gg, vcs.gg2, nrow = 2, ncol = 1)

  #print to file if specified.
  if(!is.null(file)){
    save_plot(filename = paste(file, 'pdf', sep = '.'), plot = gg.summary, base_width = width, base_height = height, base_aspect_ratio = 1.5)
  }

  print(gg.summary)

}
