#' Plots maf summary.
#'
#' @description Plots maf summary.
#' @param maf an MAF object generated by \code{\link{read.maf}}
#' @param file If given pdf file will be generated.
#' @param width plot parameter for output file.
#' @param height plot parameter for output file.
#' @param rmOutlier If TRUE removes outlier from boxplot.
#' @param addStat Can be either mean or median. Default NULL.
#' @param rmSilent remove silent variants from the plot.
#' @param showBarcodes include sample names in the top bar plot.
#' @param named vector of colors for each Variant_Classification.
#' @examples
#' plotmafSummary(maf = laml, rmSilent = T, addStat = 'median')
#' @import cowplot RColorBrewer
#' @export

plotmafSummary = function(maf, file = NULL, width = 6, height = 5, rmOutlier = TRUE, addStat = NULL, rmSilent = TRUE, showBarcodes = FALSE, textSize = 2, color = NULL){

  #require(cowplot, quietly = TRUE)
  #require(RColorBrewer, quietly = TRUE)
  #require(ggrepel, quietly = TRUE)

  addStat.opts = c('mean', 'median')


  if(is.null(color)){
    #hard coded color scheme if uoser doesnt provide any
    col = c('#CCCCCC', RColorBrewer::brewer.pal(12, name = "Paired"), brewer.pal(11, name = "Spectral")[1:3], "maroon")
    names(col) = names = c('',"Nonstop_Mutation", "Frame_Shift_Del",
                           "Intron", "Missense_Mutation", "IGR", "Nonsense_Mutation",
                           "RNA", "Splice_Site", "In_Frame_Del", "Frame_Shift_Ins",
                           "Silent", "In_Frame_Ins", "ITD", "In_Frame_Ins", "Translation_Start_Site",
                           "Multi_Hit")
  }else{
    col = color
  }


  vcs = getSampleSummary(maf)
  #vcs = vcs[,2:(ncol(vcs)-1), with = F]
  #vcs = vcs[order(rowSums(vcs[,2:ncol(vcs), with = F]), decreasing = T)] #order tsbs based on number of mutations
  vcs = vcs[,c(1,order(colSums(x = vcs[,2:(ncol(vcs)-1), with =FALSE]), decreasing = TRUE)+1), with =FALSE] #order based on most event

  #melt data frame
  vcs.m = data.table::melt(data = vcs, id = 'Tumor_Sample_Barcode')
  colnames(vcs.m) = c('Tumor_Sample_Barcode', 'Variant_Classification', 'N')

  vcs.m$Tumor_Sample_Barcode = factor(vcs.m$Tumor_Sample_Barcode,levels = vcs$Tumor_Sample_Barcode) #reorder tsb levels
  vcs.m$Variant_Classification = factor(x = vcs.m$Variant_Classification, levels = colnames(vcs)) #reorder Variant classification

  #For now keep it at 90
  textAngle = 90

  #top ggplot

  if(!is.null(addStat)){
    if(length(addStat) > 1){
      stop('addStat can only be either mean or median.')
    }

    if(! addStat %in% addStat.opts){
      stop('addStat can only be either mean or median.')
    }

    if(addStat == 'mean'){
      mean.line = round(max(maf@summary[,Mean], na.rm = TRUE), 2)
      df = data.frame(y = c(mean.line), x = as.integer(0.8*nrow(getSampleSummary(maf))), label = c(paste('Mean: ', mean.line, sep='')))

      vcs.gg = ggplot(data = vcs.m, aes(x = Tumor_Sample_Barcode, y = N, fill = Variant_Classification))+geom_bar(stat = 'identity')+scale_fill_manual(values = col)+
        theme(axis.ticks = element_blank(), axis.text.x = element_text(angle = textAngle, vjust = 0.5, hjust=1, size = textSize), legend.position = 'none')+ylab('# of Variants')+xlab('Samples')+
        background_grid(major = 'xy', minor = 'none')+geom_hline(yintercept = mean.line, linetype = 2)+
        geom_label_repel(inherit.aes = FALSE, data = df, aes(x = x, y = y, label = label), fill = 'gray', fontface = 'bold', color = 'black', box.padding = unit(1, "lines"),
                         point.padding = unit(1, "lines"), force = 20, size = 3, nudge_y = 2)
    }else{
      med.line = round(max(maf@summary[,Median], na.rm = TRUE), 2)
      df = data.frame(y = c(med.line), x = as.integer(0.8*nrow(getSampleSummary(maf))), label = c(paste('Median: ', med.line, sep='')))

      vcs.gg = ggplot(data = vcs.m, aes(x = Tumor_Sample_Barcode, y = N, fill = Variant_Classification))+geom_bar(stat = 'identity')+scale_fill_manual(values = col)+
        theme(axis.ticks = element_blank(), axis.text.x = element_text(angle = textAngle, vjust = 0.5, hjust=1, size = textSize), legend.position = 'none')+ylab('# of Variants')+xlab('Samples')+
        background_grid(major = 'xy', minor = 'none')+geom_hline(yintercept = med.line, linetype = 3)+
        geom_label_repel(inherit.aes = FALSE, data = df, aes(x = x, y = y, label = label), fill = 'gray', fontface = 'bold', color = 'black', box.padding = unit(1, "lines"),
                         point.padding = unit(1, "lines"), force = 20, size = 3, nudge_y = 2)
    }


  }else{
    vcs.gg = ggplot(data = vcs.m, aes(x = Tumor_Sample_Barcode, y = N, fill = Variant_Classification))+geom_bar(stat = 'identity')+scale_fill_manual(values = col)+
      theme(axis.ticks = element_blank(), axis.text.x = element_text(angle = textAngle, vjust = 0.5, hjust=1, size = textSize), legend.position = 'none')+ylab('# of Variants')+xlab('Samples')+
      background_grid(major = 'xy', minor = 'none')
  }

  if(!showBarcodes){
    vcs.gg = vcs.gg+theme(axis.text.x = element_blank())
  }

  #bottom ggplot
  if(rmOutlier){
    #Get box heights from boxplot.srtas
    boxH = vcs.m[,boxplot.stats(N)$stat[5], by = .(Variant_Classification)]
    colnames(boxH)[ncol(boxH)] = 'boxStat'
    vcs.gg2 = ggplot(data = vcs.m, aes(x = Variant_Classification, y = N, fill = Variant_Classification))+geom_boxplot(outlier.shape = NA)+scale_fill_manual(values = col)+
      theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = 'bottom')+
      theme(legend.key.size = unit(0.5, "cm"), legend.title = element_blank(), legend.text = element_text(size = 7))+ylim(0, max(boxH$boxStat)+5)+background_grid(major = 'xy', minor = 'none')
  } else{
    vcs.gg2 = ggplot(data = vcs.m, aes(x = Variant_Classification, y = N, fill = Variant_Classification))+geom_boxplot()+scale_fill_manual(values = col)+
      theme(axis.ticks = element_blank(), axis.text.x = element_blank(), legend.position = 'bottom')+
      theme(legend.key.size = unit(0.5, "cm"), legend.title = element_blank(), legend.text = element_text(size = 7))+background_grid(major = 'xy', minor = 'none')
  }

  #organize plots
  gg.summary = plot_grid(vcs.gg, vcs.gg2, nrow = 2, ncol = 1)

  #print to file if specified.
  if(!is.null(file)){
    save_plot(filename = paste(file, 'pdf', sep = '.'), plot = gg.summary, base_width = width, base_height = height, base_aspect_ratio = 1.5)
  }

  print(gg.summary)

}
