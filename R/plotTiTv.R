#' Plot Transition and Trasnversion ratios.
#' @description Takes results generated from \code{titv} and plots the Ti/Tv ratios and contributions of 6 mutational conversion classes in each sample.
#'
#' @param res results generated by \code{\link{titv}}
#' @param file basename for output file name. If given pdf will be generated.
#' @param width width of the plot, in inches.
#' @param height height of the plot, in inches.
#' @param color named vector of colors for each coversion class.
#' @return None.
#' @examples
#' laml.maf <- system.file("extdata", "tcga_laml.maf.gz", package = "maftools")
#' laml <- read.maf(maf = laml.maf, removeSilent = TRUE, useAll = FALSE)
#' laml.titv = titv(maf = laml, useSyn = TRUE)
#' plotTiTv(laml.titv)
#'
#' @export


plotTiTv = function(res = NULL, file = NULL, width = 6, height = 5, color = NULL){

  if(is.null(color)){
    col = RColorBrewer::brewer.pal(n = 6, name = 'Set3')
    names(col) = c('C>T', 'C>G', 'C>A', 'A>T', 'A>G', 'A>C')
  }else{
    col = color
  }


  titv.frac = res$fraction.contribution
  titv.frac.melt = data.table::melt(data = titv.frac, id = 'Tumor_Sample_Barcode')
  titv.frac.melt$variable = factor(x = titv.frac.melt$variable, levels = c('C-T', 'C-G', 'C-A', 'A-T', 'A-G', 'A-C'),
                                   labels = c('C>T', 'C>G', 'C>A', 'A>T', 'A>G', 'A>C'))

  titv.frac.melt$TiTv = suppressWarnings( factor(x = titv.frac.melt$variable, levels = c('C>T', 'C>G', 'C>A', 'A>T', 'A>G', 'A>C'),
                                   labels = c('Ti', 'Tv', 'Tv', 'Tv', 'Ti', 'Tv')) )

  titv.contrib = suppressMessages(data.table::melt(res$TiTv.fractions, id = 'Tumor_Sample_Barcode'))

  p1 = ggplot(data = titv.frac.melt, aes(x = variable, y = value, color = TiTv)) +
    geom_boxplot() + ylim(0, 100) + cowplot::theme_cowplot() +
    xlab("") + theme(axis.line = element_line(colour = "black"), legend.position = 'none') +
    ylab("Fraction of Mutations")+scale_color_manual(values = c('Ti' = 'maroon', 'Tv' = 'royalblue'))+cowplot::background_grid(major = 'xy', minor = 'none')

  p2 = ggplot(data = titv.contrib, aes(x = variable, y = value, color = variable)) +
    geom_boxplot() + ylim(0, 100) + cowplot::theme_cowplot() +
    xlab('')+theme(axis.line = element_line(colour = "black"), legend.title = element_blank(), axis.title.y = element_blank()) +
    scale_color_manual(values = c('Ti' = 'maroon', 'Tv' = 'royalblue'))+cowplot::background_grid(major = 'xy', minor = 'none')

  top = suppressWarnings(plot_grid(p1, p2, rel_widths = c(2,1)))

  p3 = ggplot(data = titv.frac.melt, aes(x = Tumor_Sample_Barcode, y = value, fill = variable))+geom_bar(stat = 'identity')+ cowplot::theme_cowplot() +
    theme(legend.position = 'bottom', legend.title = element_blank(), axis.text.x = element_blank(),
          axis.line.y = element_blank(), axis.line.x = element_blank())+ylab('Fraction of Mutations')+xlab('Samples')+
    scale_fill_manual(values = col)

  p = suppressWarnings(cowplot::plot_grid(top, p3, nrow = 2))

  print(p)

  if(!is.null(file)){
    cowplot::save_plot(filename = paste(file, 'pdf', sep='.'), plot = p, base_height = height, base_width = width)
  }
}
